<!doctype html>
<meta charset='utf-8'>
<title>Restaurant Picker</title>
<meta name='viewport' content='width=device-width, initial-scale=1'>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
  * { color-scheme: light dark; }
  body { font-family: system-ui; max-width: 500px; margin: 40px auto; padding: 20px; }
  input { width: 100%; padding: 10px; font-size: 16px; box-sizing: border-box; }
  button { padding: 10px 20px; margin: 10px 0; font-size: 14px; cursor: pointer; width: 100%; }
  .add-btn { background: #4CAF50; color: white; border: none; border-radius: 4px; }
  .suggest-btn { background: #2196F3; color: white; border: none; border-radius: 4px; font-size: 18px; padding: 15px 30px; }
  .recent-btn { background: #ff9800; color: white; border: none; border-radius: 4px; }
  .skip-btn { background: #9c27b0; color: white; border: none; border-radius: 4px; }
  .remove-btn { background: #f44336; color: white; border: none; border-radius: 4px; font-size: 12px; width: auto; margin: 0; }
  #suggestion { font-size: 32px; font-weight: bold; margin: 30px 0; text-align: center; }
  #lastChosen { font-size: 12px; margin-bottom: 20px; text-align: center; }
  .list { margin: 30px 0; }
  .restaurant-item { padding: 10px; margin: 8px 0; border-radius: 4px; display: flex; justify-content: space-between; align-items: center; }
  .info { flex: 1; }
  .restaurant-name { font-weight: bold; }
  .last-chosen { font-size: 12px; margin-top: 4px; opacity: 0.7; }

  @media (prefers-color-scheme: light) {
    body { background: white; color: #333; }
    input { background: white; color: #333; border: 1px solid #ddd; }
    .restaurant-item { background: #f5f5f5; }
    #suggestion { color: #333; }
    #lastChosen { color: #666; }
  }

  @media (prefers-color-scheme: dark) {
    body { background: #1e1e1e; color: #e0e0e0; }
    input { background: #2d2d2d; color: #e0e0e0; border: 1px solid #444; }
    .restaurant-item { background: #2d2d2d; }
    #suggestion { color: #e0e0e0; }
    #lastChosen { color: #b0b0b0; }
  }
</style>

<h1>üçΩÔ∏è Restaurant Picker</h1>

<div id="suggestion">Click "Get Suggestion" to start</div>
<div id="lastChosen"></div>

<button class="suggest-btn" onclick="getSuggestion()">Get Suggestion</button>
<button class="recent-btn" onclick="markRecent()">Had This Recently</button>
<button class="skip-btn" onclick="skipSuggestion()">Not Feeling This</button>

<div class="list">
  <h3>Your Restaurants:</h3>
  <div id="restaurantList"></div>
</div>

<h3>Add a New Restaurant:</h3>
<input id="restaurantInput" type="text" placeholder="Type a restaurant name...">
<button class="add-btn" onclick="addRestaurant()">Add Restaurant</button>

<script>
  const SUPABASE_URL = 'https://gojnnipsxdhcvlrgjios.supabase.co';
  const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imdvam5uaXBzeGRoY3ZscmdqaW9zIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMyNzE3MTUsImV4cCI6MjA3ODg0NzcxNX0.Ozs5l9yMYcOArvD4N9vFU5WslrBBN0MX9E-RyHwlcSI';

  const { createClient } = window.supabase;
  const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

  let restaurants = [];
  let currentSuggestion = null;

  async function loadRestaurants() {
    const { data, error } = await supabase
      .from('restaurants')
      .select('*')
      .order('last_chosen', { ascending: true, nullsFirst: true });
    
    if (error) return console.error('Error loading:', error);
    restaurants = data || [];
    render();
  }

  async function addRestaurant() {
    const input = document.getElementById('restaurantInput');
    const name = input.value.trim();
    if (!name) return alert('Please enter a restaurant name');
    
    const { error } = await supabase
      .from('restaurants')
      .insert([{ name, last_chosen: null }]);
    
    if (error) return alert('Error adding restaurant');
    input.value = '';
    loadRestaurants();
  }

  function getSorted() {
    return [...restaurants].sort((a, b) => {
      const aTime = a.last_chosen || 0;
      const bTime = b.last_chosen || 0;
      return aTime - bTime;
    });
  }

  async function getSuggestion() {
    if (restaurants.length === 0) return alert('Add some restaurants first!');
    
    const sorted = getSorted();
    currentSuggestion = sorted[0];
    
    await supabase
      .from('restaurants')
      .update({ last_chosen: Date.now() })
      .eq('id', currentSuggestion.id);
    
    loadRestaurants();
  }

  function skipSuggestion() {
    if (!currentSuggestion) return alert('Get a suggestion first');
    
    const sorted = getSorted();
    const nextIndex = sorted.findIndex(r => r.id === currentSuggestion.id) + 1;
    
    if (nextIndex >= sorted.length) {
      currentSuggestion = sorted[0];
    } else {
      currentSuggestion = sorted[nextIndex];
    }
    
    displaySuggestion();
  }

  function displaySuggestion() {
    document.getElementById('suggestion').textContent = currentSuggestion.name;
    const lastText = currentSuggestion.last_chosen 
      ? `Last chosen: ${new Date(currentSuggestion.last_chosen).toLocaleDateString()}`
      : 'Never chosen yet';
    document.getElementById('lastChosen').textContent = lastText;
  }

  function markRecent() {
    if (!currentSuggestion) return alert('Get a suggestion first');
    getSuggestion();
  }

  async function removeRestaurant(id) {
    await supabase
      .from('restaurants')
      .delete()
      .eq('id', id);
    
    loadRestaurants();
  }

  function render() {
    const sorted = getSorted();
    if (currentSuggestion) {
      displaySuggestion();
    }
    
    const list = document.getElementById('restaurantList');
    list.innerHTML = restaurants.map(r => `
      <div class="restaurant-item">
        <div class="info">
          <div class="restaurant-name">${r.name}</div>
          <div class="last-chosen">${r.last_chosen ? `Last: ${new Date(r.last_chosen).toLocaleDateString()}` : 'Never chosen'}</div>
        </div>
        <button class="remove-btn" onclick="removeRestaurant(${r.id})">Remove</button>
      </div>
    `).join('');
  }

  loadRestaurants();

  // Listen for real-time changes
  supabase
    .channel('restaurants')
    .on('postgres_changes', { event: '*', schema: 'public', table: 'restaurants' }, () => {
      loadRestaurants();
    })
    .subscribe();
</script>
